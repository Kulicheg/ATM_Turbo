Изменения в этой версии MoonRabbit:
1) Не реализован вывод логотипа при запуске.
2) Обновлен исходный код до версии  оригинального проекта 31.10.2021.
3) Исправлена ошибка  отображения строк длиннее 60 символов
4) Исправлено отображение адресной строки
5) Расширен  экран до 80 символов
6) добавлена поддержка ATM-UART и AT-firmware для ESЗ





Во-первых LVD отрефакторил код  прошивки контроллера клавиатуры ( Для работы со старыми версиями  может потребоваться откорректировать скорость порта)
1) теперь поддерживается толко 8952
2) Выровненв таблица  баудрейтов  и добавлен 115200
3) поддерживается кварц только 11.0592
https://github.com/lvd2/ATM2-mcu

Мною подключена плата ESP8266 напрямую к 8952, так-как на плате нет гребенки под UART с TTL уровнями.
Был опробован вариант с конвертером уровней и без, работают они одинаково. По заявлениям ES GPIO у нее 5v tolerant.
В качестве прошивки в ESP использовалась официальная  AT firmware.
Схема подключения достаточно  очевидная, кроме одного момента необходимо установит диод  между D8 и 02 выводом 8952 иначе у ESP буду проблемы с загрузкой.

Vin - 5v
Gnd - GND
02 CTS	- |< - D8 RTS (IO15)
05 RTS	- D7 CTS (IO13)
10 RX - TX (IO01)
11 TX - RX (IO03)

Но без софта железка мертва. За основу был взят порт MoonRabbit под nedoOS, он написан под работу с данной прошивкой и что важно, модульно, а следовательно легко можно  написать свой модуль для работы с любым портом.

работа с портом в АТМ сделана немного крышесносяще, чтобы записать в порт из него нужно читать. При этом каждый раз передавая команду контроллеру, проверять доступность порта перед работой с ним. 

В итоге процедура отправки 1 (одного) байта выглядит вот так (для разных команд  у меня остались разные способы адресации, но они в целом равнозначны).

write: 
		di
		push bc
		push de		

		ld  c, a		;В А получаем байт, сораняем его в C
readytx:
		ld	a,#55		;подать комнаду контроллеру клавиатуры
		in	a,(#0FE)
		ld	a,#42		;команда - прочесть статус
		in	a,(#0FE)
		bit	 6, a		;Параметры - TX 
		jp z,readytx	; вернуться если байта нет
		ld  a, c
		ei
		PUSH	AF
		
		di
		LD	BC,#55FE	;порт 55FEh
		IN	A,(C)		;Переход в режим команды
		LD	B,#03		;03 - запись
		IN	A,(C)
		POP	AF		
		LD	B,A			;БАЙТ для пересылки
		IN	A,(C)		; ->
		pop de
		pop bc
		ei		
		ret

Сравните с тем как это делает MB03, да и любая вменяемая система:

write:    
    ld d, a
    ld bc, UART_GetStatus
.wait   
    in a, (c) : and UART_TX_BUSY : jr nz, .wait
    out (c), d
    ret


После  немного подправив make файлы, собрал свою версию. MoonRabbit заработал, но  максимальная скорость потока без ошибок  передачи это 38400, что могло быть проблемой, но реальная скорость  передачи  находится в районе 1 кб/с что составляет аж целых 9600, попытки ускорить код  ускорили код раза в 2, но после этого ровно в 2 раза выросли задержки ожидания готовности. Очень хотелось бы  чтобы это было следствие моих кривых рук, но глядя на то как  устроен протокол мн е кажется чо это предел. Так что ретро интернету - ретро скорости.


